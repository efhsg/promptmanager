window.QuillEditors=window.QuillEditors||{};window.QuillToolbar=function(){const SPINNER_SVG='<svg viewBox="0 0 18 18" width="18" height="18" class="ql-spin"><circle cx="9" cy="9" r="6" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="20 10"/></svg>';const SMART_PASTE_SVG='<svg viewBox="0 0 18 18" width="18" height="18">'+'<rect x="3" y="2" width="12" height="14" rx="1" fill="none" stroke="currentColor" stroke-width="1"/>'+'<rect x="6" y="0" width="6" height="3" rx="0.5" fill="none" stroke="currentColor" stroke-width="1"/>'+'<text x="9" y="13" text-anchor="middle" font-size="9" font-weight="bold" font-family="sans-serif" fill="currentColor">P</text>'+"</svg>";const LOAD_MD_SVG='<svg viewBox="0 0 18 18" width="18" height="18">'+'<path d="M4 2h7l4 4v10a1 1 0 01-1 1H4a1 1 0 01-1-1V3a1 1 0 011-1z" fill="none" stroke="currentColor" stroke-width="1"/>'+'<path d="M9 7v6M7 11l2 2 2-2" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>'+"</svg>";const getCsrfToken=()=>{const meta=document.querySelector('meta[name="csrf-token"]');return meta?meta.content||meta.getAttribute("content"):""};const showToast=(message,type)=>{let container=document.getElementById("quill-toolbar-toast-container");if(!container){container=document.createElement("div");container.id="quill-toolbar-toast-container";container.className="toast-container position-fixed bottom-0 end-0 p-3";container.innerHTML='<div class="toast align-items-center border-0" role="alert">'+'<div class="d-flex"><div class="toast-body"></div>'+'<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>'+"</div></div>";document.body.appendChild(container)}const toastEl=container.querySelector(".toast");toastEl.querySelector(".toast-body").textContent=message;toastEl.className="toast align-items-center border-0 text-bg-"+(type||"secondary");if(window.bootstrap&&window.bootstrap.Toast){new bootstrap.Toast(toastEl,{delay:2e3}).show()}};const ensureSpinnerCss=()=>{if(!document.getElementById("ql-spin-style")){const style=document.createElement("style");style.id="ql-spin-style";style.textContent=".ql-spin { animation: ql-spin 1s linear infinite; } @keyframes ql-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }";document.head.appendChild(style)}};const DEFAULT_IMPORT_TEXT_URL="/scratch-pad/import-text";const DEFAULT_IMPORT_MARKDOWN_URL="/scratch-pad/import-markdown";const setupSmartPaste=(quill,hidden,config)=>{const toolbar=quill.getModule("toolbar");if(!toolbar||!toolbar.container)return;const placeholder=toolbar.container.querySelector(".ql-smartPaste");if(!placeholder)return;const importUrl=config&&config.importTextUrl||DEFAULT_IMPORT_TEXT_URL;ensureSpinnerCss();const btn=document.createElement("button");btn.type="button";btn.className="ql-smartPaste";btn.title="Smart Paste (auto-detects markdown)";btn.innerHTML=SMART_PASTE_SVG;placeholder.replaceWith(btn);btn.addEventListener("click",async()=>{const originalHtml=btn.innerHTML;try{const text=await navigator.clipboard.readText();if(!text.trim()){showToast("Clipboard is empty","warning");return}btn.innerHTML=SPINNER_SVG;btn.disabled=true;const response=await fetch(importUrl,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":getCsrfToken(),"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({text:text})});const data=await response.json();if(data.success&&data.importData&&data.importData.content){const delta=typeof data.importData.content==="string"?JSON.parse(data.importData.content):data.importData.content;const Delta=Quill.import("delta");const length=quill.getLength();if(length<=1){quill.setContents(delta)}else{const range=quill.getSelection(true);quill.updateContents((new Delta).retain(range.index).concat(delta))}if(hidden){hidden.value=JSON.stringify(quill.getContents())}showToast(data.format==="md"?"Pasted as markdown":"Pasted as text","success")}else{showToast(data.message||"Failed to paste content","danger")}}catch(err){console.error("SmartPaste error:",err);showToast("Unable to read clipboard","danger")}finally{btn.innerHTML=originalHtml;btn.disabled=false}})};const setupLoadMd=(quill,hidden,config)=>{const toolbar=quill.getModule("toolbar");if(!toolbar||!toolbar.container)return;const placeholder=toolbar.container.querySelector(".ql-loadMd");if(!placeholder)return;const importUrl=config&&config.importMarkdownUrl||DEFAULT_IMPORT_MARKDOWN_URL;ensureSpinnerCss();const fileInput=document.createElement("input");fileInput.type="file";fileInput.accept=".md,.markdown,.txt";fileInput.style.display="none";document.body.appendChild(fileInput);const btn=document.createElement("button");btn.type="button";btn.className="ql-loadMd";btn.title="Load markdown file";btn.innerHTML=LOAD_MD_SVG;placeholder.replaceWith(btn);btn.addEventListener("click",()=>fileInput.click());fileInput.addEventListener("change",async function(){const file=this.files[0];if(!file)return;const originalHtml=btn.innerHTML;btn.innerHTML=SPINNER_SVG;btn.disabled=true;try{const formData=new FormData;formData.append("mdFile",file);const response=await fetch(importUrl,{method:"POST",body:formData,headers:{"X-CSRF-Token":getCsrfToken(),"X-Requested-With":"XMLHttpRequest"}});const data=await response.json();if(data.success&&data.importData&&data.importData.content){const delta=typeof data.importData.content==="string"?JSON.parse(data.importData.content):data.importData.content;const Delta=Quill.import("delta");const length=quill.getLength();if(length<=1){quill.setContents(delta)}else{const range=quill.getSelection(true);quill.updateContents((new Delta).retain(range.index).concat(delta))}if(hidden){hidden.value=JSON.stringify(quill.getContents())}showToast("Loaded "+file.name,"success")}else{showToast(data.errors?.mdFile?.[0]||data.message||"Failed to load file","danger")}}catch(err){console.error("Load MD error:",err);showToast("Failed to load file","danger")}finally{btn.innerHTML=originalHtml;btn.disabled=false;fileInput.value=""}})};return{setupSmartPaste:setupSmartPaste,setupLoadMd:setupLoadMd,showToast:showToast}}();document.addEventListener("DOMContentLoaded",()=>{const init=node=>{if(node.dataset.inited)return;node.dataset.inited=1;const hidden=document.getElementById(node.dataset.target);const cfg=JSON.parse(node.dataset.config);const quill=new Quill(node,cfg);if(hidden&&hidden.id){window.QuillEditors[hidden.id]=quill}const urlConfig={importTextUrl:node.dataset.importTextUrl,importMarkdownUrl:node.dataset.importMarkdownUrl};window.QuillToolbar.setupSmartPaste(quill,hidden,urlConfig);window.QuillToolbar.setupLoadMd(quill,hidden,urlConfig);if(hidden.value){try{quill.setContents(JSON.parse(hidden.value))}catch(e){console.warn("Delta parse",e)}}quill.on("text-change",()=>hidden.value=JSON.stringify(quill.getContents()))};document.querySelectorAll('[data-editor="quill"]').forEach(init);new MutationObserver(muts=>muts.forEach(m=>m.addedNodes.forEach(n=>n.querySelectorAll?.('[data-editor="quill"]').forEach(init)))).observe(document.body,{childList:true,subtree:true})});